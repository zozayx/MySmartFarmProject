-- ğŸ“¦ TimescaleDB í™•ì¥ ì„¤ì¹˜
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- ğŸ“Œ STEP 1: ê¸°ì¡´ ê°ì²´ ì œê±° (í•„ìš”ì‹œ)
DROP MATERIALIZED VIEW IF EXISTS daily_sensor_avg;
DROP TABLE IF EXISTS board_comments CASCADE;
DROP TABLE IF EXISTS board_posts CASCADE;
DROP TABLE IF EXISTS sensor_logs CASCADE;
DROP TABLE IF EXISTS actuator_logs CASCADE;
DROP TABLE IF EXISTS actuators CASCADE;
DROP TABLE IF EXISTS sensors CASCADE;
DROP TABLE IF EXISTS esps CASCADE;
DROP TABLE IF EXISTS farms CASCADE;
DROP TABLE IF EXISTS automation_conditions CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS store CASCADE;
DROP TABLE IF EXISTS user_devices CASCADE;
DROP TABLE IF EXISTS optimal_sensor_logs CASCADE;
-- ğŸ‘¤ ì‚¬ìš©ì í…Œì´ë¸”
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    name TEXT NOT NULL,
    nickname TEXT UNIQUE NOT NULL,
    role TEXT DEFAULT 'user',
    provider TEXT DEFAULT 'local',
    created_at TIMESTAMPTZ DEFAULT now()
);

-- ğŸŒ¾ ë†ì¥ í…Œì´ë¸”
CREATE TABLE farms (
    farm_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE,
    farm_name TEXT NOT NULL,
    location TEXT,
    farm_size DOUBLE PRECISION,
    plant_name TEXT NOT NULL,
    notes TEXT,
    temperature_optimal DOUBLE PRECISION,
    humidity_optimal DOUBLE PRECISION,
    soil_moisture_optimal DOUBLE PRECISION,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- ğŸ“Ÿ ESP ì¥ì¹˜ í…Œì´ë¸” (ê²Œì´íŠ¸ì›¨ì´ ê°œë…)
CREATE TABLE esps (
    esp_id SERIAL PRIMARY KEY,
    esp_name TEXT NOT NULL,
    farm_id INTEGER REFERENCES farms(farm_id) ON DELETE CASCADE,
    device_type TEXT,
    ip_address TEXT,
    is_connected BOOLEAN DEFAULT FALSE,
    last_seen TIMESTAMPTZ, 
    installed_at TIMESTAMPTZ DEFAULT now()
);

-- ğŸŒ¡ï¸ ì„¼ì„œ í…Œì´ë¸”
CREATE TABLE sensors (
    sensor_id SERIAL PRIMARY KEY,
    esp_id INTEGER REFERENCES esps(esp_id) ON DELETE CASCADE,
    sensor_type TEXT NOT NULL ,
    device_name TEXT NOT NULL,
    sensor_name TEXT,
    gpio_pin INTEGER CHECK (gpio_pin IN (4, 5, 13, 14, 16, 17, 18, 19, 21, 22, 23, 25, 26, 27, 32, 33)),
    unit TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    installed_at TIMESTAMPTZ DEFAULT now()
);

-- âš™ï¸ ì¥ì¹˜ (ì œì–´ê¸°) í…Œì´ë¸”
CREATE TABLE actuators (
    actuator_id SERIAL PRIMARY KEY,
    esp_id INTEGER REFERENCES esps(esp_id) ON DELETE CASCADE,
    actuator_type TEXT NOT NULL ,
    device_name TEXT NOT NULL,
    actuator_name TEXT,
    gpio_pin INTEGER CHECK (gpio_pin IN (4, 5, 13, 14, 16, 17, 18, 19, 21, 22, 23, 25, 26, 27, 32, 33)),
    is_active BOOLEAN DEFAULT TRUE,
    installed_at TIMESTAMPTZ DEFAULT now()
);

-- 1. user_devices í…Œì´ë¸” ì¶”ê°€
CREATE TABLE user_devices (
    device_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    device_type TEXT NOT NULL,
    device_subtype TEXT NOT NULL,
    gpio_pin INTEGER ,
    unit TEXT,
    status TEXT DEFAULT 'unassigned',
    assigned_farm_id INTEGER REFERENCES farms(farm_id),
    assigned_esp_id INTEGER REFERENCES esps(esp_id),
    purchased_at TIMESTAMPTZ DEFAULT now()
);

-- ìƒì  í…Œì´ë¸”
CREATE TABLE store (
    store_id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL,  -- 'sensor' or 'actuator'
    subtype VARCHAR(100) NOT NULL,
    price INT,
    communication VARCHAR(100),
    gpio_pin INTEGER CHECK (gpio_pin IN (4, 5, 13, 14, 16, 17, 18, 19, 21, 22, 23, 25, 26, 27,     32,33)),
    description TEXT,
    details TEXT,
    stock INT,
    image_url TEXT,
    size VARCHAR(100),          -- í¬ê¸°, ì˜ˆ: "10x5x3 cm"
    
    -- ì„¼ì„œ ì „ìš© í•„ë“œ
    measurement_range VARCHAR(100), -- ì¸¡ì • ê°€ëŠ¥ ë²”ìœ„, ì˜ˆ: "-40~125 â„ƒ"
    accuracy VARCHAR(100),           -- ì •í™•ë„, ì˜ˆ: "Â±0.5 â„ƒ"
    unit VARCHAR(50),           -- ì„¼ì„œ ë‹¨ìœ„ (ex: â„ƒ, %, ppm ë“±)
    
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    is_active BOOLEAN DEFAULT TRUE
);

-- ğŸ“œ ì¥ì¹˜ ì œì–´ ê¸°ë¡ í…Œì´ë¸”
CREATE TABLE actuator_logs (
    log_id SERIAL PRIMARY KEY,
    actuator_id INTEGER REFERENCES actuators(actuator_id) ON DELETE CASCADE,
    action TEXT CHECK (action IN ('on', 'off')),
    controlled_by TEXT,
    controlled_at TIMESTAMPTZ DEFAULT now()
);

-- ğŸ“ˆ ì„¼ì„œ ë¡œê·¸ í…Œì´ë¸” (í•˜ì´í¼í…Œì´ë¸”ë¡œ ì „í™˜)
CREATE TABLE sensor_logs (
    time TIMESTAMPTZ NOT NULL,
    sensor_id INTEGER REFERENCES sensors(sensor_id) ON DELETE CASCADE,
    sensor_type TEXT NOT NULL,
    sensor_value DOUBLE PRECISION NOT NULL,
    PRIMARY KEY (time, sensor_id)
);
SELECT create_hypertable('sensor_logs', 'time', if_not_exists => TRUE);

-- ğŸ“Š ì¼ë³„ ì„¼ì„œ í‰ê· ê°’ (Continuous Aggregation View)
CREATE MATERIALIZED VIEW daily_sensor_avg
WITH (timescaledb.continuous) AS
SELECT
  time_bucket('1 day', time) AS date,
  sensor_id,
  AVG(sensor_value) AS avg_value
FROM sensor_logs
GROUP BY time_bucket('1 day', time), sensor_id
WITH NO DATA;

-- ğŸ“ ê²Œì‹œê¸€ í…Œì´ë¸”
CREATE TABLE board_posts (
    post_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    plant_type TEXT,
    content TEXT,
    images TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- ğŸ’¬ ëŒ“ê¸€ í…Œì´ë¸”
CREATE TABLE board_comments (
    comment_id SERIAL PRIMARY KEY,
    post_id INTEGER REFERENCES board_posts(post_id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE,
    comment TEXT,
    commented_at TIMESTAMPTZ DEFAULT now()
);

-- âš™ï¸ ìë™í™” ì¡°ê±´ í…Œì´ë¸”
CREATE TABLE automation_conditions (
    condition_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(user_id) ON DELETE CASCADE,
    sensor_id INTEGER REFERENCES sensors(sensor_id),
    actuator_id INTEGER REFERENCES actuators(actuator_id),
    trigger TEXT CHECK (trigger IN ('above', 'below')),
    threshold DOUBLE PRECISION,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE optimal_sensor_logs (
    time TIMESTAMPTZ NOT NULL,
    sensor_type TEXT NOT NULL,
    optimal_value DOUBLE PRECISION NOT NULL,
    PRIMARY KEY (time, sensor_type)
);